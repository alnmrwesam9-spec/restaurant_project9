def dictionary_batch_upsert_lexemes(request):
    """
    ظٹط¶ظٹظپ/ظٹط­ط¯ظ‘ط« Lexemes ط¹ظ„ظ‰ ظ‚ط§ظ…ظˆط³ ط¢ظ…ظ†.
    - ط§ظ„ظ…ط³طھط®ط¯ظ… ط§ظ„ط¹ط§ط¯ظٹ: ط¯ط§ط¦ظ…ظ‹ط§ ط¹ظ„ظ‰ ظ‚ط§ظ…ظˆط³ظ‡ (ظ„ط§ ظٹظڈط³ظ…ط­ ط¨طھظ…ط±ظٹط± owner_id).
    - ط§ظ„ط£ط¯ظ…ظ†: ظٹط¬ط¨ طھظ…ط±ظٹط± owner_id طµط±ط§ط­ط©ظ‹.
    """
    data = request.data or {}
    lang = (data.get("lang") or "de").lower()
    items = data.get("items") or []
    as_ingredient = bool(data.get("as_ingredient", True))

    if not isinstance(items, list):
        return Response({"detail": "items must be a list."}, status=status.HTTP_400_BAD_REQUEST)

    # طھط­ط¯ظٹط¯ ط§ظ„ظ…ط§ظ„ظƒ ط¨ط´ظƒظ„ ط¢ظ…ظ†
    if is_admin(request.user):
        eff_owner_id = data.get("owner_id")
        if eff_owner_id is None:
            return Response({"detail": "owner_id is required for admin."}, status=status.HTTP_400_BAD_REQUEST)
        try:
            eff_owner_id = int(eff_owner_id)
        except Exception:
            return Response({"detail": "owner_id must be an integer."}, status=status.HTTP_400_BAD_REQUEST)
    else:
        eff_owner_id = request.user.id

    owner_user = get_object_or_404(User, pk=eff_owner_id)

    created = 0
    updated = 0
    out_items = []

    for raw in items:
        term = (raw.get("term") or "").strip()
        if not term:
            continue

        ing_name = (raw.get("ingredient_name") or raw.get("name") or "").strip()
        codes_str = (raw.get("allergen_codes") or raw.get("codes") or "").strip().upper()
        codes_set = {c for c in re.split(r"[,\s]+", codes_str) if c}

        # upsert lexeme ط¨ظ…ظپطھط§ط­ (owner, lang, normalized_term)
        norm = _norm(term)
        lx = (
            KeywordLexeme.objects
            .filter(owner_id=eff_owner_id, lang__iexact=lang, normalized_term=norm)
            .first()
        )

        if lx is None:
            lx = KeywordLexeme(owner=owner_user, lang=lang, term=term, normalized_term=norm, is_active=True)
            lx.save()
            created += 1
        else:
            # ط­ط¯ظ‘ط« ط§ظ„ظ…طµط·ظ„ط­ ط§ظ„ط¸ط§ظ‡ط± ظˆظپط¹ظ‘ظ„ظ‡
            changed = False
            if lx.term != term:
                lx.term = term
                changed = True
            if not lx.is_active:
                lx.is_active = True
                changed = True
            if changed:
                lx.save(update_fields=["term", "is_active"])
                updated += 1

        # ingredient (ط§ط®طھظٹط§ط±ظٹ)
        if as_ingredient and ing_name:
            ing = Ingredient.objects.filter(owner_id=eff_owner_id, name__iexact=ing_name).first()
            if ing is None:
                ing = Ingredient.objects.create(owner=owner_user, name=ing_name)
            if lx.ingredient_id != ing.id:
                lx.ingredient = ing
                lx.save(update_fields=["ingredient"])

            # ط¥ط°ط§ ط£ظڈط±ط³ظ„طھ ط£ظƒظˆط§ط¯ط› ط­ط¯ظ‘ط« ظ…ظƒظˆظ‘ظ†/lexeme ط¨ط§ظ„ط£ظƒظˆط§ط¯ (ظ…ط¬ظ…ظˆط¹ط§طھ M2M ط¹ظ„ظ‰ Allergen)
            if codes_set:
                ing_existing = set(ing.allergens.values_list("code", flat=True))
                union = sorted(ing_existing | codes_set)
                if set(union) != ing_existing:
                    alls = list(Allergen.objects.filter(code__in=union))
                    ing.allergens.set(alls)

                # ظƒط°ظ„ظƒ ط¹ظ„ظ‰ lexeme ظ†ظپط³ظ‡ (ط­طھظ‰ ظ„ظˆ ظ…ط±ط¨ظˆط· ط¨ظ…ظƒظˆظ‘ظ†)
                lx_existing = set(lx.allergens.values_list("code", flat=True))
                if codes_set - lx_existing:
                    lx_all = list(Allergen.objects.filter(code__in=sorted(lx_existing | codes_set)))
